<!DOCTYPE html>
<!-- vars :: {"template_app": "project.name.snake_case"} -->
<html>

    <head>
        <title>Edit Profile - template_app</title>
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <link rel="stylesheet" type="text/css" href="/style.css">
        <script src="/index.js"></script>
    </head>

    <body>

        <h1>Edit Profile - template_app</h1>
        
        <div class="nav">
            <a href="/" class="navbar-link">Home</a>
            <a href="/auth/user-account.html" class="navbar-link">User Account</a>
            <a href="/profile/list.html" class="navbar-link">Browse Profiles</a>
            <a onclick="logoutUser()" class="navbar-link">Logout</a>
        </div>

        <div class="centered-container">
            <form id="editProfileForm" onsubmit="handleEditProfile(event)">
                <input type="hidden" id="profileId" name="profileId">
                <input type="hidden" id="userId" name="userId">
                
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="bio">Bio:</label>
                    <textarea id="bio" name="bio" rows="4" cols="50" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="tags">Tags (comma-separated):</label>
                    <input type="text" id="tags" name="tags" placeholder="e.g., musician, photographer, artist">
                </div>
                
                <div class="form-group">
                    <label for="hierarchies">Hierarchies (comma-separated):</label>
                    <input type="text" id="hierarchies" name="hierarchies" placeholder="e.g., artist/musician, artist/photographer">
                </div>
                
                <div class="form-group">
                    <label for="metaData">Additional Data (JSON format):</label>
                    <textarea id="metaData" name="metaData" rows="3" cols="50" placeholder='{"key": "value"}'></textarea>
                </div>
                
                <div class="form-group">
                    <button type="submit">Update Profile</button>
                    <button type="button" onclick="cancelEdit()">Cancel</button>
                </div>
            </form>
            
            <div id="message"></div>
        </div>

        <script>
            // Check if user is logged in and load profile when page loads
            document.addEventListener('DOMContentLoaded', function() {
                if (!isUserLoggedIn()) {
                    showMessage('You must be logged in to edit a profile.', 'error');
                    setTimeout(() => {
                        window.location.href = '/auth/login.html';
                    }, 2000);
                    return;
                }
                
                loadProfileForEdit();
            });

            function loadProfileForEdit() {
                const urlParams = new URLSearchParams(window.location.search);
                const profileId = urlParams.get('id');
                
                if (!profileId) {
                    showMessage('Profile ID not specified.', 'error');
                    return;
                }
                
                readProfileForEdit(profileId);
            }

            function populateEditForm(profile) {
                const session = getUserSession();
                
                // Verify user owns this profile
                if (!session || session.user_id !== profile.user_id) {
                    showMessage('You can only edit your own profile.', 'error');
                    setTimeout(() => {
                        window.location.href = '/profile/list.html';
                    }, 2000);
                    return;
                }
                
                document.getElementById('profileId').value = profile.id;
                document.getElementById('userId').value = profile.user_id;
                document.getElementById('name').value = profile.name;
                document.getElementById('bio').value = profile.bio || '';
                
                const tags = profile.meta && profile.meta.tags ? profile.meta.tags.join(', ') : '';
                document.getElementById('tags').value = tags;
                
                const hierarchies = profile.meta && profile.meta.hierarchies ? profile.meta.hierarchies.join(', ') : '';
                document.getElementById('hierarchies').value = hierarchies;
                
                const data = profile.meta && profile.meta.data ? JSON.stringify(profile.meta.data, null, 2) : '';
                document.getElementById('metaData').value = data;
            }

            function cancelEdit() {
                const profileId = document.getElementById('profileId').value;
                window.location.href = `/profile/view.html?id=${profileId}`;
            }
        </script>

    </body>

</html>